/*
 * 16-BIT, HIGH-SPEED, LOW-NOISE, VOLTAGE OUTPUT 
 * DIGITAL-TO-ANALOG CONVERTER
 *
 * Copyright 2013 Instrumentation technologies d.d.
 *
 * Licensed under the GPL-2 or later.
 *
 */
#include <linux/device.h>
#include <asm/string.h>
#include <linux/kernel.h>
#include <linux/slab.h>
#include <linux/sysfs.h>
#include <linux/spi/spi.h>
#include <linux/module.h>
#include <linux/err.h>
/*
#include <linux/hwmon.h>
#include <linux/hwmon-sysfs.h>
*/
enum dac8581_variant {
	dac8581,
};

struct dac8581_data {
	struct spi_device *spi_dev;
/*	struct device *hwmon_dev;*/
};

static int dac8581_write(struct dac8581_data *chip, u16 data) {
	int ret = 0;

	ret = spi_write(chip->spi_dev, (void*) &data, sizeof(data));
	if (ret < 0)
		dev_err(&chip->spi_dev->dev, "SPI write error\n");

	return ret;
}

static ssize_t dac8581_store_dac(struct device *dev,
		struct device_attribute *attr, const char *buf, size_t size) {

	struct dac8581_data *chip;
	int ret = 0;

	long unsigned int userinput;
	u16 data = 0;

	userinput = 0;

	ret=strict_strtoul(buf, 0, &userinput);
	if(ret<0)
		return ret;
		
	data = (u16) userinput;
	
	chip = dev_get_drvdata(dev);

	ret = dac8581_write(chip, data);
	if (ret < 0)
		return ret;
		
	printk("%d\n", data);
	return size;
}

static DEVICE_ATTR( dac, S_IWUSR, NULL, dac8581_store_dac);

static struct attribute *dac8581_attributes[] = {
		&dev_attr_dac.attr, NULL, };

static const struct attribute_group dac8581_group = {
		.attrs = dac8581_attributes,
};

static int __devinit dac8581_probe(struct spi_device *spi_dev)
{
	int ret;
	struct dac8581_data *chip;

	chip = kzalloc(sizeof(*chip), GFP_KERNEL);
	if (chip == NULL) {
		ret = -ENOMEM;
		goto error_ret;
	}
	chip->spi_dev=spi_dev;

	dev_set_drvdata(&spi_dev->dev, chip);

	ret = sysfs_create_group(&spi_dev->dev.kobj, &dac8581_group);
	if (ret < 0)
	goto error_free_chip;

/*	chip->hwmon_dev = hwmon_device_register(&spi_dev->dev);

	if (IS_ERR(chip->hwmon_dev)) {
		ret = PTR_ERR(chip->hwmon_dev);
		goto error_remove_group;
	}
*/
	return 0;
/*error_remove_group:
	sysfs_remove_group(&spi_dev->dev.kobj, &dac8581_group);*/
error_free_chip:
	kfree(chip);
error_ret:
	return ret;
}

static int __devexit dac8581_remove(struct spi_device *spi_dev)
{

	struct dac8581_data *chip;

	chip = dev_get_drvdata(&spi_dev->dev);
	printk("Spi protocol driver for dac8581 remove \n");
/*	hwmon_device_unregister(chip->hwmon_dev);*/
	sysfs_remove_group(&spi_dev->dev.kobj, &dac8581_group);
	kfree(chip);

	return 0;
}

static const struct spi_device_id dac8581_id[] = { { "dac8581", dac8581 }, { } };

MODULE_DEVICE_TABLE( spi, dac8581_id);

static struct spi_driver dac8581_driver = {
		.driver = {
				.name = "dac8581",
				.owner = THIS_MODULE,
		},
		.probe = dac8581_probe,
		.remove = __devexit_p(dac8581_remove),
		.id_table = dac8581_id,
};

static __init int dac8581_init(void)
{
	printk("Spi protocol driver for  dac8581 \n");
	return spi_register_driver(&dac8581_driver);
}
module_init( dac8581_init);

static __exit void dac8581_exit(void)
{
	printk("Spi protocol driver for dac8581 bye :) \n");
	spi_unregister_driver(&dac8581_driver);
}
module_exit( dac8581_exit);

MODULE_AUTHOR("Uros Golob <uros.golob@i-tech.si>");
MODULE_DESCRIPTION("dac8581" "16bit digital to analog converter(hs,ln)");
MODULE_LICENSE("GPL v2");
